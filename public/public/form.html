<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>SmartPharm - Hatƒ±rlatƒ±cƒ± Kayƒ±t</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f4f6fb;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .main-flex {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 32px;
      margin: 40px auto;
      max-width: 950px;
    }
    .container {
      background: #fff;
      width: 400px;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      padding: 32px 28px 24px 28px;
      min-width: 320px;
    }
    .side-panel {
      background: #fff;
      width: 340px;
      min-width: 240px;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      padding: 24px 18px 18px 18px;
      display: none;
      flex-direction: column;
      max-height: 80vh;
      overflow-y: auto;
    }
    .side-panel.active {
      display: flex;
    }
    h1 {
      color: #2a5d9f;
      text-align: center;
      margin-bottom: 8px;
    }
    .desc {
      color: #555;
      font-size: 15px;
      text-align: center;
      margin-bottom: 24px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: #234;
      font-weight: 500;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      margin-bottom: 16px;
      border: 1px solid #cfd8dc;
      border-radius: 6px;
      font-size: 15px;
      box-sizing: border-box;
    }
    input[type="checkbox"] {
      width: auto;
      margin-right: 6px;
    }
    .days-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      margin-bottom: 16px;
    }
    .days-group label {
      display: flex;
      align-items: center;
      font-weight: 400;
      margin-bottom: 0;
      color: #345;
      font-size: 14px;
    }
    button {
      background: #2a5d9f;
      color: #fff;
      font-weight: bold;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #1b3e6f;
    }
    #result {
      text-align: center;
      margin-top: 10px;
      font-weight: 500;
      color: #2a5d9f;
    }
    @media (max-width: 900px) {
      .main-flex { flex-direction: column; align-items: stretch; gap: 0; }
      .side-panel { width: 100%; max-width: 100vw; min-width: 0; margin-top: 24px; }
      .container { width: 100%; min-width: 0; }
    }
  </style>
</head>
<body>
  <div class="main-flex">
    <div class="container">
      <h1>Marmara Eczanesi</h1>
      <div class="desc">M√º≈üterileriniz i√ßin otomatik ve g√ºvenli WhatsApp bilgilendirme hizmeti</div>
      <button id="showRemindersBtn" style="width:100%;margin-bottom:18px;background:#fff;color:#2a5d9f;border:1.5px solid #2a5d9f;">√ñnceden Ayarlanmƒ±≈ü M√º≈üterileri G√∂ster</button>
      <form id="reminderForm">
        <label>ƒ∞sim
          <input type="text" name="name" required>
        </label>
        <label>Telefon
          <input type="text" name="phone" required placeholder="5XXXXXXXXX">
        </label>
        <label>Mesaj
          <input type="text" name="message" required placeholder="ƒ∞la√ß adƒ±nƒ± ve mesajƒ± yazƒ±n">
        </label>
        <label>Ba≈ülangƒ±√ß Tarihi ve Saati
          <input type="datetime-local" name="startDateTime" required>
        </label>
        <label>Tekrar Tipi
          <select name="type" id="typeSelect">
            <option value="daily">Her G√ºn</option>
            <option value="weekdays">Belirli G√ºnler</option>
            <option value="delay">X G√ºn Sonra</option>
          </select>
        </label>
        <div id="daysContainer" style="display:none;">
          <div class="days-group">
            <label><input type="checkbox" name="days" value="Mon">Pazartesi</label>
            <label><input type="checkbox" name="days" value="Tue">Salƒ±</label>
            <label><input type="checkbox" name="days" value="Wed">√áar≈üamba</label>
            <label><input type="checkbox" name="days" value="Thu">Per≈üembe</label>
            <label><input type="checkbox" name="days" value="Fri">Cuma</label>
            <label><input type="checkbox" name="days" value="Sat">Cumartesi</label>
            <label><input type="checkbox" name="days" value="Sun">Pazar</label>
          </div>
        </div>
        <label>S√ºre (g√ºn)
          <input type="number" name="duration" min="1" required>
        </label>
        <div style="font-size:13px;color:#666;margin-bottom:14px;">
          <b>Bilgi:</b> S√ºre, takvim g√ºn√º olarak hesaplanƒ±r. √ñrneƒüin 10 g√ºn ve Salƒ±/Cuma se√ßerseniz, 10 g√ºn boyunca gelen her Salƒ± ve Cuma mesaj g√∂nderilir. (Yani 10 g√ºn i√ßinde 2 Salƒ± varsa 2 mesaj g√∂nderilir.)
        </div>
        <button type="submit">Kaydet</button>
      </form>
      <div id="result"></div>
    </div>
    <div class="side-panel" id="sideRemindersPanel">
      <h2 style="color:#2a5d9f;text-align:center;font-size:20px;margin-bottom:16px;">M√º≈üteri Listesi</h2>
      <div id="remindersList"></div>
    </div>
  </div>
  <div id="toast" style="display:none;position:fixed;top:32px;right:32px;z-index:9999;min-width:180px;max-width:320px;padding:16px 24px;background:#2a5d9f;color:#fff;font-weight:bold;border-radius:8px;box-shadow:0 4px 16px #0002;font-size:16px;transition:opacity 0.3s;opacity:0;pointer-events:none;text-align:center;"></div>
  <div id="editModeBanner" style="display:none;background:#e3f0ff;color:#2a5d9f;font-weight:bold;text-align:center;padding:8px 0 6px 0;border-radius:7px 7px 0 0;margin-bottom:8px;">D√ºzenleme Modu: Kaydƒ± g√ºncelledikten sonra tekrar kayƒ±t ekleyebilirsiniz.</div>
  <script>
    const typeSelect = document.getElementById('typeSelect');
    const daysContainer = document.getElementById('daysContainer');
    const showRemindersBtn = document.getElementById('showRemindersBtn');
    const sideRemindersPanel = document.getElementById('sideRemindersPanel');
    const remindersList = document.getElementById('remindersList');
    const form = document.getElementById('reminderForm');
    let remindersVisible = false;
    let remindersData = [];

    typeSelect.addEventListener('change', function() {
      daysContainer.style.display = this.value === 'weekdays' ? 'block' : 'none';
    });

    showRemindersBtn.addEventListener('click', async function(e) {
      e.preventDefault();
      remindersVisible = !remindersVisible;
      if(remindersVisible) {
        showRemindersBtn.textContent = 'M√º≈üteri Listesini Gizle';
        sideRemindersPanel.classList.add('active');
        remindersList.innerHTML = '<div style="text-align:center;color:#888;">Y√ºkleniyor...</div>';
        try {
          const res = await fetch('http://localhost:3000/api/reminders');
          const data = await res.json();
          if(Array.isArray(data) && data.length > 0) {
            remindersData = data;
            remindersList.innerHTML = data.map(rem => `
              <div style=\"background:#f7fafd;position:relative;border-radius:12px;padding:18px 18px 14px 18px;margin-bottom:16px;box-shadow:0 1px 4px #e3eaf2;min-height:120px;\">
                <button class=\"delete-reminder-btn\" data-id=\"${rem.id}\" title=\"Kaydƒ± Sil\" style=\"position:absolute;top:10px;right:10px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:#f3f3f3;color:#c00;border:none;font-size:15px;cursor:pointer;padding:0;border-radius:50%;transition:background 0.2s,color 0.2s;z-index:2;\" onmouseover=\"this.style.background='#ffeaea';this.style.color='#fff';this.style.backgroundColor='#c00'\" onmouseout=\"this.style.background='#f3f3f3';this.style.color='#c00';this.style.backgroundColor=''\">üóëÔ∏è</button>
                <button class=\"edit-reminder-btn\" data-id=\"${rem.id}\" title=\"Kaydƒ± D√ºzenle\" style=\"position:absolute;top:10px;right:44px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:#f3f3f3;color:#2a5d9f;border:none;font-size:15px;cursor:pointer;padding:0 0 0 1px;border-radius:50%;transition:background 0.2s,color 0.2s;z-index:2;\" onmouseover=\"this.style.background='#e3f0ff';this.style.color='#fff';this.style.backgroundColor='#2a5d9f'\" onmouseout=\"this.style.background='#f3f3f3';this.style.color='#2a5d9f';this.style.backgroundColor=''\">‚úèÔ∏è</button>
                <div style=\"font-weight:bold;font-size:17px;margin-bottom:2px;word-break:break-word;\">${rem.name}</div>
                <div style=\"color:#2a5d9f;font-size:13px;margin-bottom:6px;word-break:break-all;\">${rem.phone}</div>
                <div style=\"font-size:14px;margin-bottom:6px;white-space:pre-line;word-break:break-word;\">${rem.message}</div>
                <div style=\"font-size:12px;color:#888;\"><b>Ba≈ülangƒ±√ß:</b> ${rem.startDateTime ? new Date(rem.startDateTime).toLocaleString('tr-TR') : '-'}</div>
                <div style=\"font-size:12px;color:#888;\"><b>Tekrar:</b> ${rem.type === 'daily' ? 'Her G√ºn' : rem.type === 'weekdays' ? (rem.days ? rem.days.join(', ') : 'Belirli G√ºnler') : 'X G√ºn Sonra'}</div>
              </div>
            `).join('');
          } else {
            remindersList.innerHTML = '<div style="text-align:center;color:#888;">Kayƒ±tlƒ± m√º≈üteri yok.</div>';
          }
        } catch {
          remindersList.innerHTML = '<div style="text-align:center;color:#c00;">Liste alƒ±namadƒ±.</div>';
        }
        // Silme butonlarƒ±na event ekle
        remindersList.querySelectorAll('.delete-reminder-btn').forEach(btn => {
          btn.addEventListener('click', async function() {
            const id = this.getAttribute('data-id');
            if(confirm('Bu kaydƒ± silmek istediƒüinize emin misiniz?')) {
              try {
                const res = await fetch(`http://localhost:3000/api/reminders/${id}`, { method: 'DELETE' });
                if(res.ok) {
                  this.closest('div').remove();
                  alert('Kayƒ±t silindi!');
                } else {
                  alert('Silme i≈ülemi ba≈üarƒ±sƒ±z.');
                }
              } catch {
                alert('Silme i≈ülemi sƒ±rasƒ±nda hata olu≈ütu.');
              }
            }
          });
        });
        // D√ºzenle butonlarƒ±na event ekle
        remindersList.querySelectorAll('.edit-reminder-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const rem = remindersData.find(r => r.id === id);
            if(rem) {
              form.name.value = rem.name;
              form.phone.value = rem.phone;
              form.message.value = rem.message;
              form.startDateTime.value = rem.startDateTime ? rem.startDateTime.slice(0,16) : '';
              form.type.value = rem.type;
              if(rem.type === 'weekdays' && rem.days) {
                daysContainer.style.display = 'block';
                form.querySelectorAll('input[name="days"]').forEach(cb => {
                  cb.checked = rem.days.includes(cb.value);
                });
              } else {
                daysContainer.style.display = 'none';
                form.querySelectorAll('input[name="days"]').forEach(cb => { cb.checked = false; });
              }
              form.duration.value = rem.duration;
              form.setAttribute('data-edit-id', id);
              document.getElementById('editModeBanner').style.display = 'block';
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }
          });
        });
      } else {
        showRemindersBtn.textContent = '√ñnceden Ayarlanmƒ±≈ü M√º≈üterileri G√∂ster';
        sideRemindersPanel.classList.remove('active');
      }
    });

    document.getElementById('reminderForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const data = {
        name: form.name.value,
        phone: form.phone.value,
        message: form.message.value,
        startDateTime: form.startDateTime.value,
        type: form.type.value,
        duration: form.duration.value
      };
      if (form.type.value === 'weekdays') {
        data.days = Array.from(form.querySelectorAll('input[name="days"]:checked')).map(cb => cb.value);
      }
      const editId = form.getAttribute('data-edit-id');
      let res, result;
      if(editId) {
        res = await fetch(`http://localhost:3000/api/reminders/${editId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        result = await res.json();
        if(res.ok) {
          showToast('Kayƒ±t g√ºncellendi!');
          form.reset();
          form.removeAttribute('data-edit-id');
          document.getElementById('editModeBanner').style.display = 'none';
          daysContainer.style.display = 'none';
          // Listeyi hemen g√ºncelle
          if(remindersVisible) {
            await showRemindersBtn.click();
            setTimeout(()=>showRemindersBtn.click(), 200);
          }
        } else {
          showToast('Hata: ' + (result.error || 'G√ºncelleme ba≈üarƒ±sƒ±z.'), true);
        }
      } else {
        res = await fetch('http://localhost:3000/api/reminders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        result = await res.json();
        document.getElementById('result').innerText = res.ok ? 'Kayƒ±t ba≈üarƒ±lƒ±!' : 'Hata: ' + result.error;
        if(res.ok) showToast('Kayƒ±t ba≈üarƒ±lƒ±!');
        else showToast('Hata: ' + result.error, true);
        daysContainer.style.display = 'none';
        if(remindersVisible) {
          await showRemindersBtn.click();
          setTimeout(()=>showRemindersBtn.click(), 200);
        }
      }
    });

    function showToast(msg, isError = false) {
      const toast = document.getElementById('toast');
      toast.innerText = msg;
      toast.style.background = isError ? '#c00' : '#2a5d9f';
      toast.style.display = 'block';
      toast.style.opacity = '1';
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => { toast.style.display = 'none'; }, 400);
      }, 3000);
    }
  </script>
</body>
</html>

